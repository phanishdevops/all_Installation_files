need two network adapters NAT and Host only in vmware


#disable swap and in fstab also

sudo swapoff -a
sudo apt install -y curl
#(disable firewalld)
systemctl disable --now ufw 
sudo apt update -y
sudo apt install linux-headers-$(uname -r) -y
#sudo vmware-modconfig --console --install-all
#overlay and br_netfilter need to be enabled in linux before installing on master and slave

cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

lsmod | grep overlay
lsmod | grep br_netfilter

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

sudo sysctl --system 




#Install this on all master and worker nodes:

sudo apt install -y curl
sudo apt update && sudo apt install -y containerd
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
sudo systemctl restart containerd
sudo systemctl enable containerd
sudo ctr version
#sudo apt update && sudo apt install -y curl gnupg2 software-properties-common apt-transport-https ca-certificates
sudo rm -f /etc/apt/sources.list.d/kubernetes.list
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key |  sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
#(it will hold the automatic updates and prevents from version changes)
sudo apt-mark hold kubelet kubeadm kubectl
kubeadm version
kubectl version --client

Initialize Kubernetes Cluster on masternode

Check the IP Address which you want to publish to your worker nodes. In my case since my first adapter is NAT which has a static IP of 10.0.2.15, 
so I want to use my secondary Host-Only network adapter for all internal communication within cluster.
 
 NAT IP : master node:192.168.153.129 and client node: 192.168.153.131
 Host-Only: master node:192.168.40.129 and client node: 192.168.40.129
 
Execute the following command on master only. Calico CNI expects --pod-network-cidr=192.168.0.0/16

sudo kubeadm init --apiserver-advertise-address=192.168.40.129 --pod-network-cidr=192.168.40.0/16

mkdir -p $HOME/.kube
echo "Directory 'MyNewDirectory' created."
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

kubectl get nodes (shows not ready)
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.29.0/manifests/calico.yaml
kubectl get nodes (shows now as ready)
 

Go to worker Node and enter join command which copied from the output of kubeadm init command in master node and paste it in worker node to join the cluster.

kubeadm join 192.168.153.129:6443 --token 1h87e3.tsctnz8wn6nywmt5 
--discovery-token-ca-cert-hash sha256:8622e5c98b08314ab89c8637b3162f782eed255368ee66e026939511688d3283

In master Node
kubectl get nodes (now it will show worker node added and ready)
........................................................................................................................
Below command in master node will show which pod is in which worker node with there pod IP's
kubectl get pods -o wide

NAME      READY   STATUS    RESTARTS   AGE   IP               NODE                  NOMINATED NODE   READINESS GATES
nginx-1   1/1     Running   0          17s   192.168.71.147   client2-example.com   <none>           <none>
........................................................................................................................

 
